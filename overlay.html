<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CX Hunt Overlay</title>

    <style>
      :root {
        --accent: #4fff00;      /* Kick green */
        --overlay-width: 730px; /* tweak via ?w= */
      }
      html, body { background: transparent; }
      /* Black outline effect for readability on any background */
      .text_black_outline_lg {
        text-shadow:
          2px 0 #000,
          -2px 0 #000,
          0 2px #000,
          0 -2px #000,
          1.5px 1.5px 0 #000,
          -1.5px 1.5px 0 #000,
          1.5px -1.5px 0 #000,
          -1.5px -1.5px 0 #000;
      }
    </style>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;800;900&display=swap" rel="stylesheet" />
    <style>
      .font-inter { font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    </style>
  </head>
  <body class="antialiased">
    <!-- Anchored bottom-right, hugging content -->
    <div id="root" class="font-inter fixed right-3 bottom-3 w-fit">
      <div class="flex items-center justify-start gap-2">
        <!-- Left: rank + username (white with black outline) -->
        <div class="font-extrabold text-white text_black_outline_lg text-base md:text-xl tracking-wide">
          <span id="rank">#--</span>
          <span id="name">username</span>
        </div>
        <!-- Right: stats (green with black outline) -->
        <div class="text-right leading-[22px]">
          <p class="font-extrabold text_black_outline_lg text-[color:var(--accent)] text-sm md:text-base"><span id="rfids">0</span> RFIDs</p>
          <p class="font-extrabold text_black_outline_lg text-[color:var(--accent)] text-sm md:text-base"><span id="points">0</span> points</p>
        </div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const qs = new URLSearchParams(location.search);

      function getSlugFromPath() {
        const parts = location.pathname.split('/').filter(Boolean);
        return parts[parts.length - 1] || '';
      }

      let fetchUrl = qs.get("fetchUrl");
      const intervalMs = Number(qs.get("interval") || 5000);
      const widthPx = Number(qs.get("w") || 730);
      const color = (qs.get("color") || "4fff00").replace("#","");

      if (!fetchUrl) {
        const slug = getSlugFromPath();
        if (slug) fetchUrl = `${location.origin}/overlay/${encodeURIComponent(slug)}?format=json`;
      }

      // width param kept for compatibility (unused now since w-fit); can still control font scale via CSS in OBS
      document.documentElement.style.setProperty("--overlay-width", widthPx + "px");
      document.documentElement.style.setProperty("--accent", "#" + color);

      const staticDefaults = {
        username: qs.get("name") || getSlugFromPath() || "username",
        leaderboard_ranking: qs.get("rank") || "--",
        rfids_scanned: qs.get("rfids") || "0",
        points: qs.get("points") || "0",
        kick_slug: qs.get("kick") || qs.get("name") || getSlugFromPath() || ""
      };

      function coalesce(...vals) {
        for (const v of vals) {
          if (v !== undefined && v !== null && v !== "") return v;
        }
        return undefined;
      }

      function render(data) {
        const name = coalesce(data?.username, data?.name, data?.kick_slug, staticDefaults.username);
        const rank = coalesce(
          data?.display_rank,
          data?.leaderboard_ranking_live,
          data?.leaderboard_position,
          data?.leaderboard_ranking,
          data?.rank,
          data?.position,
          staticDefaults.leaderboard_ranking
        );
        const rfids = coalesce(data?.rfids_scanned, data?.rfids, data?.rfid_count, staticDefaults.rfids_scanned);
        const points = coalesce(data?.points, data?.score, staticDefaults.points);

        $("name").textContent = name;
        $("rank").textContent = "#" + rank;
        $("rfids").textContent = rfids;
        $("points").textContent = points;
      }

      render(staticDefaults);

      async function poll() {
        try {
          if (!fetchUrl) return;
          const res = await fetch(fetchUrl, { cache: "no-store" });
          const json = await res.json();
          render(json);
        } catch (e) {
          /* ignore */
        } finally {
          if (fetchUrl) setTimeout(poll, intervalMs);
        }
      }
      poll();
    </script>
  </body>
</html>